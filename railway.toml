[build]
builder = "nixpacks"

[deploy]
numReplicas = 1
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10

[[services]]
name = "mysql"
icon = "mysql"

[services.mysql.source]
image = "mysql:8.0"

[services.mysql.variables]
MYSQL_ROOT_PASSWORD = "password"
MYSQL_DATABASE = "transcription_db"

[services.mysql.healthcheck]
command = ["mysqladmin", "ping", "-h", "localhost"]
interval = 30
timeout = 20
retries = 10

[[services]]
name = "backend"
icon = "fastapi"

[services.backend.source]
repo = "https://github.com/leonj1/scribe-amp"
rootDirectory = "/backend"

[services.backend.variables]
MYSQL_URL = "${{mysql.MYSQLURL}}"
JWT_SECRET = "${{JWT_SECRET}}"
GOOGLE_CLIENT_ID = "${{GOOGLE_CLIENT_ID}}"
GOOGLE_CLIENT_SECRET = "${{GOOGLE_CLIENT_SECRET}}"
LLM_API_KEY = "${{LLM_API_KEY}}"
AUDIO_STORAGE_PATH = "/app/audio_files"
PORT = "8000"

[services.backend.healthcheck]
path = "/health"
interval = 30
timeout = 10
retries = 5

[[services]]
name = "frontend"
icon = "react"

[services.frontend.source]
repo = "https://github.com/leonj1/scribe-amp"
rootDirectory = "/frontend"

[services.frontend.variables]
REACT_APP_API_URL = "${{backend.RAILWAY_PUBLIC_DOMAIN}}"
REACT_APP_GOOGLE_CLIENT_ID = "${{GOOGLE_CLIENT_ID}}"
